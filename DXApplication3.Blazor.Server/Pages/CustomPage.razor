@page "/custompage"
@using static DXApplication3.Blazor.Server.Pages.CustomPage
@inject HttpClient Http
@inject IHttpContextAccessor HttpContextAccessor
@inject IJSRuntime JS


@using DXApplication3.Module.BusinessObjects
@using DevExpress.ExpressApp
@using DevExpress.ExpressApp.Core
@using DevExpress.ExpressApp.Security
@using DevExpress.Persistent.BaseImpl.EF.PermissionPolicy
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@inject ISecurityProvider SecurityProvider
@inject IObjectSpaceFactory ObjectSpaceFactory  // Nếu cần load full user object
@inject INonSecuredObjectSpaceFactory NonSecuredObjectSpaceFactory
@inject NavigationManager NavigationManager


<h3>Trang Custom với Chart.js</h3>

<p>Xin chào: @currentUserName</p>

<canvas id="myChart" width="400" height="200"></canvas>


<h3>Dữ liệu từ API</h3>

@if (employDtos == null)
{
    <p><em>Đang tải dữ liệu…</em></p>
}
else
{
    <ul>
        @foreach (var item in employDtos)
        {
            <li>@item.FirstName - @item.LastName</li>
        }
    </ul>
}


@code {

    private String? currentUserName;



    private List<Employee>? employDtos;


    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {


        try
        {
            var userId = SecurityProvider.GetSecurity().UserId;
            if (userId != null)
            {
                // Sử dụng extension method trên INonSecuredObjectSpaceFactory
                using var objectSpace = NonSecuredObjectSpaceFactory.CreateNonSecuredObjectSpace<PermissionPolicyUser>();  // Generic cho type user
                var currentUser = objectSpace.GetObjectByKey<PermissionPolicyUser>(userId);  // Thay type nếu dùng custom user
                currentUserName = currentUser?.UserName ?? "Unknown";
            }
            else
            {
                currentUserName = "Người dùng chưa đăng nhập";
            }


            //Goi native code
            using var os = ObjectSpaceFactory.CreateObjectSpace(typeof(Employee));
            var items = os.GetObjects<Employee>();
            // xử lý trực tiếp luôn, không gọi API nữa
            employDtos = os.GetObjects<Employee>().ToList();
        }
        catch (Exception ex)
        {
            currentUserName = $"Lỗi: {ex.Message}";
        }


    }


    protected override async System.Threading.Tasks.Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load Chart.js
            await JS.InvokeVoidAsync("eval", @"
                if(!window.ChartLoaded){
                  var script = document.createElement('script');
                  script.src='https://cdn.jsdelivr.net/npm/chart.js';
                  script.onload=function(){ window.ChartLoaded=true; };
                  document.head.appendChild(script);
                }
            ");

            // Đợi chart.js load xong
            await System.Threading.Tasks.Task.Delay(500);

            // Gọi API

            // 1. Lấy cookie xác thực hiện tại
            var authCookieName = ".AspNetCore.Cookies"; // hoặc tên cookie của bạn
            var cookieValue = HttpContextAccessor.HttpContext.Request.Cookies[authCookieName];

            // 2. Lấy URL API gốc tự động
            var request = HttpContextAccessor.HttpContext.Request;
            var baseUrl = $"{request.Scheme}://{request.Host.Value}";
            // var baseUri = new Uri(baseUrl);
            var baseUri = new Uri(NavigationManager.BaseUri);

            Console.WriteLine($"cookieValue: {cookieValue}"); // Debug
            Console.WriteLine($"baseUrl: {baseUrl}");

            var handler = new HttpClientHandler
                {
                    UseCookies = true,
                    ServerCertificateCustomValidationCallback = (message, cert, chain, errors) => true
                };
            handler.CookieContainer = new System.Net.CookieContainer();
            handler.CookieContainer.Add(
               //new Uri(NavigationManager.BaseUri), // địa chỉ API
               baseUri,
                new System.Net.Cookie(authCookieName, cookieValue));


            // // Create handler to bypass SSL
            // var handler = new HttpClientHandler
            //     {
            //         UseCookies=true,
            //         CookieContainer =  new System.Net.CookieContainer(),
            //         ServerCertificateCustomValidationCallback = (message, cert, chain, errors) => true
            //     };



            // Create new HttpClient with handler and set BaseAddress
            using var client = new HttpClient(handler);
            client.BaseAddress = baseUri;

            Console.WriteLine($"BaseAddress: {Http.BaseAddress}"); // Debug
            var data = await client.GetFromJsonAsync<ChartData>("api/MyData/GetChartData");

            // vi du goi api van can auth
            //employDtos = await client.GetFromJsonAsync<List<employDto>>("api/MyData/GetEmployee");
 

            // Render Chart
            var js = $@"
              const ctx = document.getElementById('myChart');
              new Chart(ctx, {{
                type: 'bar',
                data: {{
                  labels: {System.Text.Json.JsonSerializer.Serialize(data.Labels)},
                  datasets: [{{
                    label: 'Demo',
                    data: {System.Text.Json.JsonSerializer.Serialize(data.Values)}
                  }}]
                }}
              }});
            ";

            await JS.InvokeVoidAsync("eval", js);
        }
    }

    class ChartData
    {
        public string[] Labels { get; set; }
        public int[] Values { get; set; }
    }
}
